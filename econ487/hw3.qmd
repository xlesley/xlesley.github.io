---
title: "HW3"
output: html_document
date: "2023-10-18"
author: "Lesley Xu"
---

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(broom)
library(knitr)
```

1)	Let’s focus on two variables HHLARGE (“fraction of households that are large”) and EDUC (“fraction of shoppers with advanced education”). 

a.	What are the means and percentiles of each of these variables?
HINT: `summary(oj$EDUC)`

```{r, message=FALSE, warning=FALSE}
setwd("/Users/lesleyxu/Desktop/Past courses/23AU/ECON 487")
oj <- read.csv("oj.csv")

kable(tidy(summary(oj$HHLARGE)))
kable(tidy(summary(oj$EDUC)))
```

b.	Using your coefficient estimates from the regression in Q9 of the previous problem set (if you did not include HHLARGE and EDUC, rerun the regression with them included):
```{r, message=FALSE, warning=FALSE}
reg1 <- lm(logmove ~ log(price) * feat * brand + AGE60 + EDUC + ETHNIC + INCOME + HHLARGE + WORKWOM + HVAL150 + SSTRDIST + SSTRVOL + CPDIST5 + CPWVOL5, oj)
kable(tidy(summary(reg1)))
```

i.	If we move from the median value of HHLARGE to the 75th percentile (3rd quartile), how much does log(quantity) change each week on average?

```{r, message=FALSE, warning=FALSE}
coef_hhlarge <- coef(reg1)["HHLARGE"]
hhlarge_75 <- summary(oj$HHLARGE)["3rd Qu."]
hhlarge_med <- median(oj$HHLARGE)
change_in_hhlarge <- exp(coef_hhlarge * (hhlarge_75 - hhlarge_med))
```

  - Log(quantity) will change `r change_in_hhlarge` each week on average. 
  
  ii.	If we move from the median value of EDUC to the 75th percentile (3rd quartile), how much does log(quantity) change each week on average?
```{r, message=FALSE, warning=FALSE}
coef_educ <- coef(reg1)["EDUC"]
educ_75 <- summary(oj$EDUC)["3rd Qu."]
educ_med <- median(oj$EDUC)
change_in_educ <- exp(coef_educ * (educ_75 - educ_med))
```

  - Log(quantity) will change `r change_in_educ` each week on average. 


  iii.	Base on this analysis, which is the more important predictor of demand?
    
  - HHLARGE is the more important predictor of demand becaus it has a larger absolute value of coefficient. 

c.	Now let’s see if these variables impact price sensitivity. Add two interaction terms (with logprice) to the model to test this. 

  
  i.	What are the coefficients on the interaction terms? 
  
```{r, message=FALSE, warning=FALSE}
reg2 <- lm(logmove ~ log(price) * feat * brand + HHLARGE + EDUC + HHLARGE : log(price) + EDUC : log(price), oj)
kable(tidy(summary(reg2)))
coef_reg2_educ <- coef(reg2)["log(price):EDUC"]
coef_reg2_hhlarge <- coef(reg2)["log(price):HHLARGE"]
```

  - The coefficients on the interaction terms is `r coef_reg2_educ` for interaction term of EDUC and log(price), `r coef_reg2_hhlarge` for interaction term of HHLARGE and log(price). 

    ii.	Does the sign of your estimates make sense based on your intuition?

    - The sign make sense based on my intuition, because EDUC seems to have negative influence on the price elasticity of demand, and HHLARGE . 
      
    iii.	What are the coefficient estimates on the variables EDUC and HHLARGE that aren’t part of the interaction term? How do they compare to your regression from 1b?
  
    - Compare to my regression from 1b, coefficients on EDUC and HHLARGE have flipped sign, -3.0553118 and 0.9199127 respectively. 
      
    iv.	Similar to 2b, if we move from the median value of each variable to the 3rd quartile, how much does elasticity change? Based on this, which is more important to price sensitivity?
    
```{r, message=FALSE, warning=FALSE}

```
    - The elasticity will change by .
    
d.	You should notice that the coefficients on EDUC and HHLARGE have flipped sign once we include interaction terms with price. HHLARGE now appears to be a positive demand shifter and increases price sensitivity. Explain in words or pictures what is going on.

  - Before adding the interaction term, the coefficient is positive for EDUC and negative for HHLARGE, while after adding the interaction term, the coefficient is negative for EDUC and positive for HHLARGE. After adding the interaction term, the price demand elasticity increases as HHLARGE increases. 

2)	Create make a new dataframe which takes the previous week’s prices as a variable on the same line as the current week. This would enable you to see if there is intertemporal substitution. 

a.	There are going to be a couple of steps. First is creating a new dataframe which is like the old one except that the week variable will change by a single week

```{r, message=FALSE, warning=FALSE}
df1 <- oj
df1$week <- df1$week+1

df2 <- merge(oj, df1, by=c("brand","store","week"))
```

b.	Now run a regression with this week’s log(quantity) on current and last week’s price.

```{r, message=FALSE, warning=FALSE}
# .x is lagged variables
reg_curr_lag <- lm(logmove.y ~ price.y + price.x, df2)
kable(tidy(summary(reg_curr_lag)))
```

c.	What do you notice about the previous week’s elasticity?  Does this make sales more or less attractive from a profit maximization perspective?  Why?

- The log(quantity) are more influence by current week's price than previous week's price. This makes sales less attractive from a profit maximization perspective because the absolute value of coefficient for current price is larger than the coefficient for previous price. 

3)	In the last assignment you calculated the MSE on a test set. Let’s expand that code to include 5-fold cross validation.  

a.	Create 5 partitions of the data of equal size.
```{r, message=FALSE, warning=FALSE}
# set seed and randomize the data
set.seed(487)
oj_random <- df2[sample(nrow(df2)), ]

# manually split
s1 <- oj_random %>%
  filter(row_number(oj_random) <= nrow(oj_random) * 0.2)

s2 <- oj_random %>%
  filter(nrow(oj_random) * 0.2 < row_number(oj_random),  row_number(oj_random) <= nrow(oj_random) * 0.4)

s3 <- oj_random %>%
  filter(nrow(oj_random) * 0.4 < row_number(oj_random),  row_number(oj_random) <= nrow(oj_random) * 0.6)

s4 <- oj_random %>%
  filter(nrow(oj_random) * 0.6 < row_number(oj_random),  row_number(oj_random) <= nrow(oj_random) * 0.8)

s5 <- oj_random %>%
  filter(nrow(oj_random) * 0.8 < row_number(oj_random),  row_number(oj_random) <= nrow(oj_random))
```


b.	Create 5 training datasets using 80% of the data for each one. This could be done by “appending” the data together using rbind or via sampling.
```{r, message=FALSE, warning=FALSE}
train1 <- sample_n(s1, 0.8 * nrow(s1), replace = FALSE)
train2 <- sample_n(s2, 0.8 * nrow(s2), replace = FALSE)
train3 <- sample_n(s3, 0.8 * nrow(s3), replace = FALSE)
train4 <- sample_n(s4, 0.8 * nrow(s4), replace = FALSE)
train5 <- sample_n(s5, 0.8 * nrow(s5), replace = FALSE)

test1 <- s1 %>%
  anti_join(train1)
test2 <- s2 %>%
  anti_join(train2)
test3 <- s3 %>%
  anti_join(train3)
test4 <- s4 %>%
  anti_join(train4)
test5 <- s5 %>%
  anti_join(train5)
```

c.	Estimate a complex model using OLS which includes price, featured, brand, brand*price and lagged price, all the sociodemographic variables and interactions of EDUC and HHSIZE with price on each of the training sets then the MSE on the test sets using the predict command.

    i.	Calculate the MSE for the model on the test set for each fold (e.g., there will be five sets of model parameters and five test set MSEs with 5-fold cross validation).  
```{r, message=FALSE, warning=FALSE}

# reg_train1 <- glm(logmove.y ~ price.y + feat.y + brand + brand * price.y + price.x + AGE60.y + EDUC.y + ETHNIC.y + INCOME.y + HHLARGE.y + WORKWOM.y + HVAL150.y + SSTRDIST.y + SSTRVOL.y + CPDIST5.y + CPWVOL5.y + EDUC.y * price.y + HHLARGE.y * price.y, train1, family = gaussian)
```
    
    ii.	Average across the MSEs to get the cross validated MSE for an OLS model run on that particular set of features.
```{r, message=FALSE, warning=FALSE}
mse <- function(model, test_set){
  return(round(mean((test_set$logmove - predict(model, newdata=test_set))^2), 2))
}
```
    
    BONUS: Do (3) but using the same week’s prices of other brand’s OJ in the same regression. Here’s a hint from base R: dcast(oj_prices, store + week ~ brand).  See if you can do the same but with dplyr or another R package.  Try doing this for only a single brand of orange juice as a first step. 
    

#### Theoretical Questions:

1)	Assume that in addition to orange juice, you also observe demand for bananas.

a.	What regression would you run to determine if bananas and orange juice are complements or substitutes?  What is the coefficient of interest (i.e. on what variable) that would inform you?

- I will run the regression of log(price) of orange juice and log(price) of bananas on logemove of orange juice. The coefficient of log(price of bananas) and log(price of orange juice) would inform me whether those products are complements or substitutes.  


b.	Assume you find they are substitutes. What would the sign of the coefficient be? Would you be more or less likely to bundle these products if they are substitutes?  

    i.	Explain why with an equation, figure or a sentence or two. 
    
  $$C = P_{1}Q_{1} + P_{2}Q_{2}$$
  - If the two products are substitutes, the sign of the coefficient would be negative. I will try to bundle substitutes because there are real life examples of bundling same kind of products actually promotes the sale by increasing the margin profit of selling one unit. When two products are bundles, one of them has a positive coefficient while the other has a negative coefficient, the increase of $P_{1}$ will lead to a decrease of $Q_{2}$, therefore the coefficient should have opposite signs.
  
  
    ii.	Would the price of the bundle be less than or more than the sum of the two independent prices?  (Not a trick question; verifying you understand bundles.)
    
    - Bundles do not necessarily have a substitute/complement relationship. Number of products in the bundle matters. Overall bundles of substitutes attracts more consumers, even there are multiple number of products under the same kind. 
    
c.	During a sale for orange juice, should you continue to offer the bundle? Why or why not?  HINT: who is price sensitive for orange juice?  Who comes into market?  Would you want to offer the bundle at a lower price than before?  

- Intertemporal elasticity of orange juice. Orange juice today is a substitute for orange juice tomorrow because it does not go bad after one day, but not the case for bananas. Bananas could not last very long, and the products of today and tomorrow are having different elasticity. 
