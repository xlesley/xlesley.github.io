<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lesley Xu">
<meta name="dcterms.date" content="2023-10-25">

<title>HW4</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="hw4_files/libs/clipboard/clipboard.min.js"></script>
<script src="hw4_files/libs/quarto-html/quarto.js"></script>
<script src="hw4_files/libs/quarto-html/popper.min.js"></script>
<script src="hw4_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hw4_files/libs/quarto-html/anchor.min.js"></script>
<link href="hw4_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hw4_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hw4_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hw4_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hw4_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">HW4</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lesley Xu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 25, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>Take a model that includes brand, feat, log(price), their interactions, lagged price, and demographics, and fit a LASSO using glmnet which is a workhorse R package for LASSO, Ridge and Elastic Nets.<br>
</li>
</ol>
<ol type="a">
<li>First remember to install the glmnet package and library to your R session.<br>
</li>
<li>Remember to estimate a LASSO you must pass glmnet a matrix of data for candidate features and a vector as candidate outcomes: As an alternative to defining products in a dataframe, turning that into a matrix then passing that matrix to glmnet, you can cut out the middle man with this. In addition to the variables in the original dataframe, try to create tons of new features that you think could plausibly be predictive of quantity sold. This could include lagged prices, interactions of several features, etc.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/Users/lesleyxu/Desktop/Past courses/23AU/ECON 487"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>oj <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'oj.csv'</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>demo_cols <span class="ot">&lt;-</span> oj <span class="sc">%&gt;%</span> </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age60<span class="sc">:</span>hval150) <span class="sc">%&gt;%</span> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>oj_cv <span class="ot">&lt;-</span> oj <span class="sc">%&gt;%</span> </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">log_price =</span> <span class="fu">log</span>(price)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(week) <span class="sc">%&gt;%</span> <span class="co"># sort the data by week</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(store, brand) <span class="sc">%&gt;%</span> <span class="co"># only lag within a store and brand</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">lag_price =</span> <span class="fu">ifelse</span>(<span class="fu">lag</span>(week) <span class="sc">+</span> <span class="dv">1</span> <span class="sc">==</span> week, <span class="fu">lag</span>(log_price), <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> <span class="co"># calculate lagged prices only if subsequent weeks</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lag_price)) <span class="sc">%&gt;%</span>  <span class="co"># remove observations without a lagged price</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dataset_id =</span> <span class="fu">sample</span>(</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>           <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>), <span class="fu">ceiling</span>(<span class="fu">n</span>()<span class="sc">/</span><span class="dv">5</span>)), </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="fu">n</span>(), </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">replace =</span> <span class="cn">FALSE</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>         ))</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>reg_int <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">'logmove ~ log_price*brand*feat + lag_price + '</span> , <span class="fu">str_c</span>(demo_cols, <span class="at">collapse =</span> <span class="st">' + '</span>))</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">720</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="fu">formula</span>(reg_int), oj_cv)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> oj_cv<span class="sc">$</span>logmove</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>lasso_v1 <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x, y, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">#Results</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lasso_v1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hw4_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now ready for cross validation version of the object</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>cvfit <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x, y, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Results</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cvfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hw4_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="3" type="a">
<li>Investigate the coefficients of the cross validated LASSO model. Which are the parameters the cross validated LASSO model kicks out of the model? What is the ratio of number of features to number of observations? How might that relate to overfitting from “sampling error”?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">head</span>((<span class="fu">coef</span>(lasso_v1, <span class="at">s=</span>lasso_v1<span class="sc">$</span>lambda.min))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>6 x 84 sparse Matrix of class "dgCMatrix", with 378 entries
    i  j            x
1   1  1  9.174759303
2   1  2  9.147502884
3   6  2  0.115177698
4   1  3  9.122667850
5   6  3  0.220123328
6   1  4  9.137104379
7   3  4 -0.044735129
8   6  4  0.307084797
9   1  5  9.198998204
10  3  5 -0.144321532
11  6  5  0.374931775
12  1  6  9.255379285
13  3  6 -0.235043734
14  6  6  0.436754749
15  1  7  9.306751625
16  3  7 -0.317706425
17  6  7  0.493085540
18  1  8  9.353560188
19  3  8 -0.393025590
20  6  8  0.544412059
21  1  9  9.396210408
22  3  9 -0.461653608
23  6  9  0.591178872
24  1 10  9.435071699
25  3 10 -0.524184903
26  6 10  0.633791049
27  1 11  9.470480661
28  3 11 -0.581161089
29  6 11  0.672617679
30  1 12  9.502723191
31  3 12 -0.633050569
32  6 12  0.707999917
33  1 13  9.532122170
34  3 13 -0.680355416
35  6 13  0.740234037
36  1 14  9.558909435
37  3 14 -0.723457844
38  6 14  0.769604565
39  1 15  9.583316993
40  3 15 -0.762731172
41  6 15  0.796365896
42  1 16  9.609172394
43  3 16 -0.806288431
44  5 16  0.007755749
45  6 16  0.820254098
46  1 17  9.660753042
47  3 17 -0.905156519
48  5 17  0.072527057
49  6 17  0.838070759
50  1 18  9.716015098
51  3 18 -1.009895418
52  5 18  0.142116254
53  6 18  0.831914695
54  1 19  9.757471879
55  3 19 -1.128310780
56  5 19  0.200639750
57  6 19  0.817767584
58  1 20  9.761402938
59  3 20 -1.252293581
60  5 20  0.247525869
61  6 20  0.802442665
62  1 21  9.765246733
63  3 21 -1.365854905
64  5 21  0.290376393
65  6 21  0.788229476
66  1 22  9.768678890
67  3 22 -1.468996319
68  5 22  0.329526745
69  6 22  0.775403236
70  1 23  9.769847549
71  3 23 -1.563958577
72  5 23  0.365096470
73  6 23  0.763408275
74  1 24  9.767174154
75  3 24 -1.656570317
76  4 24  0.011869145
77  5 24  0.407502237
78  6 24  0.754107276
79  1 25  9.769202175
80  3 25 -1.761055429
81  4 25  0.058491345
82  5 25  0.474183941
83  6 25  0.750982144
84  1 26  9.799092382
85  3 26 -1.856822262
86  4 26  0.100702462
87  5 26  0.535015873
88  6 26  0.747825311
89  1 27  9.820573000
90  3 27 -1.944877556
91  4 27  0.139777382
92  5 27  0.591494244
93  6 27  0.744862189
94  1 28  9.808471667
95  3 28 -2.026126793
96  4 28  0.176024383
97  5 28  0.644608766
98  6 28  0.741954486
99  1 29  9.880396201
100 3 29 -2.100760917
101 4 29  0.209139412
102 5 29  0.692933065
103 6 29  0.739244934
104 1 30  9.936463007
105 3 30 -2.168743101
106 4 30  0.239296578
107 5 30  0.736949463
108 6 30  0.736774649
109 1 31  9.987131439
110 3 31 -2.230691872
111 4 31  0.266778297
112 5 31  0.777060569
113 6 31  0.734523302
114 1 32 10.029740882
115 3 32 -2.287180562
116 4 32  0.294522222
117 5 32  0.819152899
118 6 32  0.743990768
119 1 33 10.067770364
120 3 33 -2.337800155
121 4 33  0.321575491
122 5 33  0.860466738
123 6 33  0.759664970
124 1 34 10.102016108
125 3 34 -2.384441995
126 4 34  0.346236447
127 5 34  0.898103329
128 6 34  0.773591280
129 1 35 10.133338116
130 3 35 -2.426495676
131 4 35  0.368447786
132 5 35  0.932181957
133 6 35  0.786098623
134 1 36 10.161748264
135 3 36 -2.465246888
136 4 36  0.388934326
137 5 36  0.963439509
138 6 36  0.797663159
139 1 37 10.187616127
140 3 37 -2.500562802
141 4 37  0.407605593
142 5 37  0.991923278
143 6 37  0.808205689
144 1 38 10.214686732
145 3 38 -2.542346674
146 4 38  0.427782628
147 5 38  0.999349626
148 6 38  0.817783928
149 1 39 10.242571911
150 3 39 -2.582675844
151 4 39  0.446537338
152 5 39  0.993164864
153 6 39  0.826037403
154 1 40 10.264838948
155 3 40 -2.619284235
156 4 40  0.463467197
157 5 40  0.987618861
158 6 40  0.833510737
159 1 41 10.283030151
160 3 41 -2.652220915
161 4 41  0.478807056
162 5 41  0.983536148
163 6 41  0.840353811
164 1 42 10.300810336
165 3 42 -2.682441123
166 4 42  0.492824229
167 5 42  0.979284833
168 6 42  0.846571406
169 1 43 10.316566086
170 3 43 -2.709687233
171 4 43  0.505417786
172 5 43  0.976089298
173 6 43  0.852192989
174 1 44 10.332950596
175 3 44 -2.735096151
176 4 44  0.517252420
177 5 44  0.971825445
178 6 44  0.857598943
179 1 45 10.460674838
180 3 45 -2.747597987
181 4 45  0.526085190
182 5 45  0.968629319
183 6 45  0.880667110
184 1 46 10.582391987
185 3 46 -2.764070914
186 4 46  0.511449586
187 5 46  0.967238764
188 6 46  0.905713847
189 1 47 10.691634694
190 3 47 -2.781940591
191 4 47  0.495067775
192 5 47  0.961029904
193 6 47  0.927597837
194 1 48 10.791630412
195 3 48 -2.798857697
196 4 48  0.481058396
197 5 48  0.955384932
198 6 48  0.946514364
199 1 49 10.882714353
200 3 49 -2.814176910
201 4 49  0.468605438
202 5 49  0.950903837
203 6 49  0.963565384
204 1 50 10.965723000
205 3 50 -2.828211974
206 4 50  0.457342109
207 5 50  0.946540795
208 6 50  0.979027089
209 1 51 11.041396610
210 3 51 -2.841113608
211 4 51  0.446696308
212 5 51  0.942174406
213 6 51  0.993259080
214 1 52 11.110124990
215 3 52 -2.852691111
216 4 52  0.437482833
217 5 52  0.938956218
218 6 52  1.006064098
219 1 53 11.172878107
220 3 53 -2.863310618
221 4 53  0.428656188
222 5 53  0.935478471
223 6 53  1.017845638
224 1 54 11.228817264
225 3 54 -2.873022073
226 4 54  0.413586467
227 5 54  0.928909430
228 6 54  1.030060683
229 1 55 11.282358629
230 3 55 -2.889457887
231 4 55  0.387473218
232 5 55  0.920949463
233 6 55  1.028561535
234 1 56 11.332830407
235 3 56 -2.906791458
236 4 56  0.364266707
237 5 56  0.916421687
238 6 56  1.023000678
239 1 57 11.378733901
240 3 57 -2.922243048
241 4 57  0.343573405
242 5 57  0.912616194
243 6 57  1.018458517
244 1 58 11.420690753
245 3 58 -2.936742785
246 4 58  0.324199409
247 5 58  0.908922651
248 6 58  1.013870276
249 1 59 11.458922898
250 3 59 -2.949928408
251 4 59  0.306714741
252 5 59  0.905566455
253 6 59  1.009742823
254 1 60 11.493822218
255 3 60 -2.962112017
256 4 60  0.290523720
257 5 60  0.902401453
258 6 60  1.005797453
259 1 61 11.525663253
260 3 61 -2.973314933
261 4 61  0.275665820
262 5 61  0.899463745
263 6 61  1.002093462
264 1 62 11.554688438
265 3 62 -2.983560347
266 4 62  0.262108282
267 5 62  0.896763286
268 6 62  0.998681764
269 1 63 11.581008688
270 3 63 -2.992628203
271 4 63  0.250245457
272 5 63  0.894451906
273 6 63  0.995872207
274 1 64 11.605090849
275 3 64 -3.001120107
276 4 64  0.238947913
277 5 64  0.892197741
278 6 64  0.993054050
279 1 65 11.630185423
280 3 65 -3.015063003
281 4 65  0.221157161
282 5 65  0.885085468
283 6 65  0.981339457
284 1 66 11.652014106
285 3 66 -3.025025095
286 4 66  0.209630799
287 5 66  0.874905502
288 6 66  0.973398299
289 1 67 11.671834178
290 3 67 -3.034075675
291 4 67  0.199009378
292 5 67  0.864908843
293 6 67  0.966351483
294 1 68 11.689657553
295 3 68 -3.041809682
296 4 68  0.190038924
297 5 68  0.856235207
298 6 68  0.960684194
299 1 69 11.705937507
300 3 69 -3.048978607
301 4 69  0.181634927
302 5 69  0.848066287
303 6 69  0.955402676
304 1 70 11.720862355
305 3 70 -3.055711045
306 4 70  0.173722848
307 5 70  0.840368823
308 6 70  0.950318802
309 1 71 11.734380441
310 3 71 -3.061666060
311 4 71  0.166811361
312 5 71  0.833625567
313 6 71  0.945912840
314 1 72 11.746704881
315 3 72 -3.067122382
316 4 72  0.160442958
317 5 72  0.827400174
318 6 72  0.941885670
319 1 73 11.757985707
320 3 73 -3.072198849
321 4 73  0.154493731
322 5 73  0.821605127
323 6 73  0.938052238
324 1 74 11.768250025
325 3 74 -3.076819057
326 4 74  0.149105005
327 5 74  0.816333824
328 6 74  0.934600001
329 1 75 11.777461120
330 3 75 -3.080765332
331 4 75  0.144602164
332 5 75  0.811946617
333 6 75  0.931751014
334 1 76 11.786006081
335 3 76 -3.084608664
336 4 76  0.140058914
337 5 76  0.807529211
338 6 76  0.928850329
339 1 77 11.793722105
340 3 77 -3.088060625
341 4 77  0.136045614
342 5 77  0.803612428
343 6 77  0.926292193
344 1 78 11.800692276
345 3 78 -3.091115018
346 4 78  0.132530450
347 5 78  0.800171990
348 6 78  0.924081364
349 1 79 11.807191489
350 3 79 -3.094084483
351 4 79  0.129006823
352 5 79  0.796723231
353 6 79  0.921830445
354 1 80 11.813065497
355 3 80 -3.096776322
356 4 80  0.125867472
357 5 80  0.793679977
358 6 80  0.919753917
359 1 81 11.818301272
360 3 81 -3.099107799
361 4 81  0.123211273
362 5 81  0.791098410
363 6 81  0.918028806
364 1 82 11.823236358
365 3 82 -3.101371299
366 4 82  0.120537918
367 5 82  0.788492000
368 6 82  0.916289821
369 1 83 11.827531425
370 3 83 -3.103294015
371 4 83  0.118351386
372 5 83  0.786356356
373 6 83  0.914880075
374 1 84 11.831626995
375 3 84 -3.105160983
376 4 84  0.116150207
377 5 84  0.784200738
378 6 84  0.913459629</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(cvfit<span class="sc">$</span>lambda.min)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -8.317741</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(cvfit, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>21 x 1 sparse Matrix of class "dgCMatrix"
                                         s1
(Intercept)                     11.83162700
(Intercept)                      .         
log_price                       -3.10516098
brandminute.maid                 0.11615021
brandtropicana                   0.78420074
feat                             0.91345963
lag_price                        0.45750163
age60                            1.40535449
educ                             0.50130998
ethnic                           0.55180588
income                          -0.13127520
hhlarge                         -1.26167163
workwom                         -1.39771457
hval150                          0.36073584
log_price:brandminute.maid       0.67432566
log_price:brandtropicana         0.60278678
log_price:feat                  -0.06914071
brandminute.maid:feat            1.03415531
brandtropicana:feat              0.34555577
log_price:brandminute.maid:feat -1.20760533
log_price:brandtropicana:feat   -0.80701294</code></pre>
</div>
</div>
<ol start="4" type="a">
<li>Can you look that the glmnet objects and figure out what the out of sample (e.g., test set) average MSE was with the cross validated LASSO model relative to the model in 1.c?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cvfit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  cv.glmnet(x = x, y = y, alpha = 1) 

Measure: Mean-Squared Error 

      Lambda Index Measure       SE Nonzero
min 0.000244    84  0.4381 0.004054      19
1se 0.005260    51  0.4419 0.004231      17</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>oj_reg_demo <span class="ot">&lt;-</span> oj <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id_val =</span> <span class="fu">row_number</span>(),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_price =</span> <span class="fu">log</span>(price))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> oj_reg_demo <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>df_test <span class="ot">&lt;-</span> oj_reg_demo <span class="sc">%&gt;%</span> </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(df_train,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">'id_val'</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>reg_str <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">'logmove ~ log_price*feat*brand + '</span>, <span class="fu">str_c</span>(demo_cols, <span class="at">collapse =</span> <span class="st">' + '</span>))</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>reg_form <span class="ot">&lt;-</span> <span class="fu">formula</span>(reg_str)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>demo_reg_train <span class="ot">&lt;-</span> <span class="fu">lm</span>(reg_form, <span class="at">data =</span> df_train)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>reg_train <span class="ot">&lt;-</span> <span class="fu">lm</span>(logmove <span class="sc">~</span> log_price<span class="sc">*</span>feat<span class="sc">*</span>brand, <span class="at">data =</span> df_train)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>mse <span class="ot">&lt;-</span> <span class="cf">function</span>(model, test_set){</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">round</span>(<span class="fu">mean</span>((test_set<span class="sc">$</span>logmove <span class="sc">-</span> <span class="fu">predict</span>(model, <span class="at">newdata=</span>test_set))<span class="sc">^</span><span class="dv">2</span>), <span class="dv">2</span>))</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mse</span>(demo_reg_train, df_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.43</code></pre>
</div>
</div>
<ul>
<li>The average MSE with the cross validated LASSO model is 0.4419, and the MSE for test set with demographic variables included from last problem is 0.45. Therefore, the LASSO model did a better job since it has a lower MSE.</li>
</ul>
<ol start="5" type="a">
<li><p>What is the advantage of using LASSO for choosing model complexity as opposed to using your intuition as an economist?</p></li>
<li><p>In what part of this process did you use your intuition as an economist? (HINT: what’s in the X matrix?)</p></li>
</ol>
<ul>
<li>By using LASSO, I am able to reduce as much coefficient to zero as possible, and the left non-zero coefficient will be the more significant variables in my model. LASSO shrinks the coefficients of less important variables to zero while keep the important variables. And because the model selected according to LASSO will be less complex, it will help avoid overfitting at the same time.</li>
</ul>
<ol start="2" type="1">
<li>Now estimate the model with only the variable selected with the LASSO procedure but with OLS to avoid attenuation bias in the coefficients (similar to this paper).<br>
</li>
</ol>
<ol type="a">
<li><p>Let’s return to the orange juice assignment and get very precise about how to interpret coefficients. What is the predicted elasticity in the following cases?</p></li>
<li><p>For Dominicks when the lagged price is $1 (NOTE: did you interact lagged price with current period price?) If not, does lagged price impact the elasticity this period or log move this period.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> <span class="fu">coef</span>(cvfit, <span class="at">s =</span> cvfit<span class="sc">$</span>lambda<span class="fl">.1</span>se)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the variables with nonzero coefficients</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(<span class="fu">coef</span>(cvfit, <span class="at">s =</span> <span class="st">'lambda.1se'</span>))[<span class="fu">coef</span>(cvfit, <span class="at">s =</span> <span class="st">'lambda.1se'</span>)[,<span class="dv">1</span>]<span class="sc">!=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">x</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
</tr>
<tr class="even">
<td style="text-align: left;">log_price</td>
</tr>
<tr class="odd">
<td style="text-align: left;">brandminute.maid</td>
</tr>
<tr class="even">
<td style="text-align: left;">brandtropicana</td>
</tr>
<tr class="odd">
<td style="text-align: left;">feat</td>
</tr>
<tr class="even">
<td style="text-align: left;">lag_price</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age60</td>
</tr>
<tr class="even">
<td style="text-align: left;">educ</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ethnic</td>
</tr>
<tr class="even">
<td style="text-align: left;">income</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hhlarge</td>
</tr>
<tr class="even">
<td style="text-align: left;">workwom</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hval150</td>
</tr>
<tr class="even">
<td style="text-align: left;">log_price:brandminute.maid</td>
</tr>
<tr class="odd">
<td style="text-align: left;">log_price:brandtropicana</td>
</tr>
<tr class="even">
<td style="text-align: left;">log_price:feat</td>
</tr>
<tr class="odd">
<td style="text-align: left;">brandminute.maid:feat</td>
</tr>
<tr class="even">
<td style="text-align: left;">log_price:brandtropicana:feat</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>oj_cv_price <span class="ot">&lt;-</span> oj <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">log_price =</span> <span class="fu">log</span>(price)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(week) <span class="sc">%&gt;%</span> <span class="co"># sort the data by week</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(store, brand) <span class="sc">%&gt;%</span> <span class="co"># only lag within a store and brand</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">lag_price =</span> <span class="fu">ifelse</span>(<span class="fu">lag</span>(week) <span class="sc">+</span> <span class="dv">1</span> <span class="sc">==</span> week, <span class="fu">lag</span>(price), <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> <span class="co"># calculate lagged prices only if subsequent weeks</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lag_price)) <span class="sc">%&gt;%</span>  <span class="co"># remove observations without a lagged price</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dataset_id =</span> <span class="fu">sample</span>(</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>           <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>), <span class="fu">ceiling</span>(<span class="fu">n</span>()<span class="sc">/</span><span class="dv">5</span>)), </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="fu">n</span>(), </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">replace =</span> <span class="cn">FALSE</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>         ))</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="st">'logmove ~ log_price + + log(lag_price) + log_price*log(lag_price) + brand + brand*log_price + brand*feat + brand*feat*log_price + income + educ + hhlarge + workwom + age60 + feat + age60*income + age60*log_price + educ*log_price + hhlarge*log_price + workwom*log_price + hhlarge*workwom + educ*workwom + income*workwom + income*hhlarge'</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>dom_lag_1 <span class="ot">&lt;-</span> oj_cv_price <span class="sc">%&gt;%</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brand <span class="sc">==</span> <span class="st">'dominicks'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lag_price <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="i">
<li>For Tropicana</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>trop_pred <span class="ot">&lt;-</span> oj_cv_price <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brand <span class="sc">==</span> <span class="st">'tropicana'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="i">
<li>For Tropicana when its featured</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>trop_feat <span class="ot">&lt;-</span> oj_cv_price <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brand <span class="sc">==</span> <span class="st">'tropicana'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feat <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="i">
<li>What is the 95% confidence intervals for Tropicana</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>reg2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mod2, oj_cv_price)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ci_trop <span class="ot">&lt;-</span> <span class="fu">confint</span>(reg2, <span class="st">"brandtropicana"</span>, <span class="at">level=</span><span class="fl">0.95</span>, oj_cv_price)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>ci_trop <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">2.5 %</th>
<th style="text-align: right;">97.5 %</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">brandtropicana</td>
<td style="text-align: right;">0.3093633</td>
<td style="text-align: right;">0.5455199</td>
</tr>
</tbody>
</table>
</div>
</div>
<ol start="2" type="a">
<li><p>Which product has the most elastic demand?</p></li>
<li><p>Should that product have the highest markup over costs or lowest markup over costs? Why?</p></li>
</ol>
<ol start="3" type="1">
<li>Go back to using logmove and log(price).<br>
</li>
</ol>
<ol type="a">
<li>Estimate a 3x3 matrix own price and cross price elasticities for Dominicks, Minute Maid, and Tropicana using only the current week’s prices. Be sure to estimate separate models for sales of Dominicks, MM and Tropicana (e.g., you’ll run three separate regressions with the same RHS variables but different LHS variables). It doesn’t need to be overly complicated, but make sure there is an interpretable elasticity estimate. NOTE: This will require three different regressions &amp; add in socio demographic controls for each store.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>wide_data <span class="ot">&lt;-</span> oj_reg_demo <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(store, week, brand, log_price) <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(store,week), </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> brand, </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from=</span>log_price</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>cross_price_data <span class="ot">&lt;-</span> oj_reg_demo <span class="sc">%&gt;%</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(store, week, logmove, brand) <span class="sc">%&gt;%</span> </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(wide_data,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'store'</span>, <span class="st">'week'</span>))</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># split the dataset according to brand</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>oj_dominicks <span class="ot">&lt;-</span> oj_reg_demo <span class="sc">%&gt;%</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(brand <span class="sc">==</span> <span class="st">'dominicks'</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>oj_tropicana <span class="ot">&lt;-</span> oj_reg_demo <span class="sc">%&gt;%</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(brand <span class="sc">==</span> <span class="st">'tropicana'</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>oj_minutemaid <span class="ot">&lt;-</span> oj_reg_demo <span class="sc">%&gt;%</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(brand <span class="sc">==</span> <span class="st">'minute.maid'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rejoin the logmove and log price </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>oj_dominicks<span class="sc">$</span>logprice_tropicana <span class="ot">&lt;-</span> oj_tropicana<span class="sc">$</span>log_price</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>oj_dominicks<span class="sc">$</span>logmove_tropicana <span class="ot">&lt;-</span> oj_tropicana<span class="sc">$</span>logmove</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>oj_dominicks<span class="sc">$</span>logprice_minutemaid <span class="ot">&lt;-</span> oj_minutemaid<span class="sc">$</span>log_price</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>oj_dominicks<span class="sc">$</span>logmove_minutemaid <span class="ot">&lt;-</span> oj_minutemaid<span class="sc">$</span>logmove</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>demo_cols_cross <span class="ot">&lt;-</span> oj <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age60<span class="sc">:</span>cpwvol5) <span class="sc">%&gt;%</span> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>()</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>reg_domi <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">'logmove ~ log_price + logprice_minutemaid + logprice_tropicana + '</span> , <span class="fu">str_c</span>(demo_cols_cross, <span class="at">collapse =</span> <span class="st">' + '</span>))</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>model.dominicks <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">formula</span>(reg_domi),oj_dominicks)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>reg_trop <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">'logmove_tropicana ~ log_price + logprice_minutemaid + logprice_tropicana + '</span> , <span class="fu">str_c</span>(demo_cols_cross, <span class="at">collapse =</span> <span class="st">' + '</span>))</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>model.tropicana <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">formula</span>(reg_trop),oj_dominicks)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>reg_minu <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">'logmove_minutemaid ~ log_price + logprice_minutemaid + logprice_tropicana + '</span> , <span class="fu">str_c</span>(demo_cols_cross, <span class="at">collapse =</span> <span class="st">' + '</span>))</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>model.minutemaid <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">formula</span>(reg_minu),oj_dominicks)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>epsilon_d <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(model.dominicks)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>epsilon_t <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(model.tropicana)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>epsilon_m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(model.minutemaid)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>matrix_cross1 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(epsilon_d, epsilon_t, epsilon_m)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(matrix_cross1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'dominicks'</span>, <span class="st">'minutemaid'</span>, <span class="st">'tropicana'</span>)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>matrix_cross1 <span class="sc">%&gt;%</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">dominicks</th>
<th style="text-align: right;">minutemaid</th>
<th style="text-align: right;">tropicana</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">epsilon_d</td>
<td style="text-align: right;">-3.5418257</td>
<td style="text-align: right;">1.2230131</td>
<td style="text-align: right;">0.0404492</td>
</tr>
<tr class="even">
<td style="text-align: left;">epsilon_t</td>
<td style="text-align: right;">0.1914969</td>
<td style="text-align: right;">0.3239453</td>
<td style="text-align: right;">-2.9725856</td>
</tr>
<tr class="odd">
<td style="text-align: left;">epsilon_m</td>
<td style="text-align: right;">0.8579440</td>
<td style="text-align: right;">-3.9284141</td>
<td style="text-align: right;">1.1143010</td>
</tr>
</tbody>
</table>
</div>
</div>
<ol start="2" type="a">
<li>Do the same but add in interactions for whether or not each brand is featured.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>reg_domi_feat <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">'logmove ~ log_price + logprice_minutemaid + logprice_tropicana + feat + '</span> , <span class="fu">str_c</span>(demo_cols_cross, <span class="at">collapse =</span> <span class="st">' + '</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>model.dominicks.feat <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">formula</span>(reg_domi_feat),oj_dominicks)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>reg_trop_feat <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">'logmove_tropicana ~ log_price + logprice_minutemaid + logprice_tropicana + feat +  '</span> , <span class="fu">str_c</span>(demo_cols_cross, <span class="at">collapse =</span> <span class="st">' + '</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>model.tropicana.feat <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">formula</span>(reg_trop_feat),oj_dominicks)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>reg_minu_feat <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">'logmove_minutemaid ~ log_price + logprice_minutemaid + logprice_tropicana + feat + '</span> , <span class="fu">str_c</span>(demo_cols_cross, <span class="at">collapse =</span> <span class="st">' + '</span>))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>model.minutemaid.feat <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">formula</span>(reg_minu_feat),oj_dominicks)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>epsilon_d_feat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(model.dominicks.feat)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>epsilon_t_feat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(model.tropicana.feat)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>epsilon_m_feat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(model.minutemaid.feat)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>matrix_cross2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(epsilon_d_feat, epsilon_t_feat, epsilon_m_feat)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(matrix_cross2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'dominicks'</span>, <span class="st">'minutemaid'</span>, <span class="st">'tropicana'</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>matrix_cross2 <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">dominicks</th>
<th style="text-align: right;">minutemaid</th>
<th style="text-align: right;">tropicana</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">epsilon_d_feat</td>
<td style="text-align: right;">-3.0566741</td>
<td style="text-align: right;">1.0434204</td>
<td style="text-align: right;">0.0008861</td>
</tr>
<tr class="even">
<td style="text-align: left;">epsilon_t_feat</td>
<td style="text-align: right;">0.1664614</td>
<td style="text-align: right;">0.3332129</td>
<td style="text-align: right;">-2.9705440</td>
</tr>
<tr class="odd">
<td style="text-align: left;">epsilon_m_feat</td>
<td style="text-align: right;">0.7724796</td>
<td style="text-align: right;">-3.8967770</td>
<td style="text-align: right;">1.1212705</td>
</tr>
</tbody>
</table>
</div>
</div>
<ol type="i">
<li>How do the estimates change?</li>
</ol>
<ul>
<li>Comparing to the previous model without feature variable, the diagonal coefficients are decreased in magnitude (smaller absolute value), meaning when take feature into account, indicating a less responsiveness to change in price.</li>
</ul>
<ol start="2" type="i">
<li>What product’s sales suffer the most when Minute Maid is both featured and lowers its price?</li>
</ol>
<ul>
<li></li>
</ul>
<ol start="3" type="a">
<li>Which two products are the most competitive with each other?</li>
</ol>
<ul>
<li>Dominicks and minute.maid are the most competitive with each other because the cross price elasticity are positive for those two brands, meaning that the increase in price of dominicks will lead to increase in price of minute.maid. They are substitutes, therefore the most competitive with each other.</li>
</ul>
<ol type="i">
<li>How did you infer that looking at the cross price elasticity?</li>
<li>What do you expect that to mean about the correlation of the prices of those two products? Would they be more correlated or less correlated than the price of other pairs of products?</li>
</ol>
<ol start="4" type="1">
<li>Create a sales weighted price for orange juice by store.<br>
</li>
</ol>
<ol type="a">
<li>You’ll first need to create actual sales (call it “Q”) instead of log sales for the weighting and put it into your dataframe.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>oj_with_Q <span class="ot">&lt;-</span> oj <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Q =</span> <span class="fu">exp</span>(logmove))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="a">
<li>You can use the weighted.mean() function for each store-week combination in the dplyr library.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>oj_weighted <span class="ot">&lt;-</span> <span class="fu">ddply</span>(oj_with_Q, <span class="fu">c</span>(<span class="st">'store'</span>,<span class="st">'week'</span>), <span class="cf">function</span>(x) <span class="fu">c</span>(<span class="at">weighted_mean =</span> <span class="fu">weighted.mean</span>(x<span class="sc">$</span>price,x<span class="sc">$</span>Q)))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>oj_with_Q <span class="ot">&lt;-</span> <span class="fu">left_join</span>(oj_with_Q, oj_weighted, <span class="at">by=</span><span class="fu">c</span>(<span class="st">'store'</span>, <span class="st">'week'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="1">
<li>Now use oj$weighted_price as the LHS variable in a regression tree to predict differences in sales weight prices with store demographics as RHS variables. Note that you’ll only need to do for a single brand since weighted price and sociodemographic variables are identical across brands within a store.</li>
</ol>
<ol type="a">
<li>There are a couple libraries you’ll need which you’ll see in the lecture notes (rpart, maptree, etc.)</li>
<li>There are two main pieces of code: <code>dataToPass&lt;-oj[,c("weighted_mean","AGE60","EDUC","ETHNIC","INCOME","HHLARGE","WORKWOM","HVAL150","SSTRDIST","SSTRVOL","CPDIST5","CPWVOL5")]</code> The above creates a dataframe from the existing one (with weighted mean merged back in) which will then be passed into rpart (tree partitioning algorithm).<br>
<code>fit&lt;-rpart(as.formula(weighted_mean ~ .),data=dataToPass,method="anova",cp=0.007)</code> This is the code which will fit the tree.</li>
<li>Play around with a couple different complexity parameters to get a feel for the data <code>draw.tree(fit)</code> #This draws the tree</li>
<li>Choose three different leaves to group stores into based upon what explains sales weighted price.</li>
<li>Assign each store to one of these leaves (we used this code previously).</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maptree)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>dataToPass <span class="ot">&lt;-</span> oj_with_Q[,<span class="fu">c</span>(<span class="st">"weighted_mean"</span>,<span class="st">"age60"</span>,<span class="st">"educ"</span>,<span class="st">"ethnic"</span>,<span class="st">"income"</span>,<span class="st">"hhlarge"</span>,<span class="st">"workwom"</span>,<span class="st">"hval150"</span>,<span class="st">"sstrdist"</span>,<span class="st">"sstrvol"</span>,<span class="st">"cpdist5"</span>,<span class="st">"cpwvol5"</span>)]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>treefit <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="fu">as.formula</span>(weighted_mean <span class="sc">~</span> .),<span class="at">data=</span>dataToPass,<span class="at">method=</span><span class="st">"anova"</span>,<span class="at">cp=</span><span class="fl">0.007</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">draw.tree</span>(treefit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hw4_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># alternative plot</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(treefit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hw4_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dataToPass<span class="sc">$</span>leaf <span class="ot">=</span> treefit<span class="sc">$</span>where</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the variables regarding hhlarge and educ from last problem set</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>treefit2 <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="fu">as.formula</span>(weighted_mean <span class="sc">~</span> educ <span class="sc">+</span> hhlarge),<span class="at">data=</span>dataToPass,<span class="at">method=</span><span class="st">"anova"</span>,<span class="at">cp=</span><span class="fl">0.007</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">draw.tree</span>(treefit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hw4_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(treefit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hw4_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="6" type="1">
<li>Estimate the own price elasticities for each one of the store buckets/leaves using the preferred specification:</li>
</ol>
<ol type="a">
<li>Now estimate cross price elasticities jointly with own price elasticities. This means you must create a dataframe which has the prices of all types of OJ at the store. (e.g., you should be able to use the Trop_Cross code you’ve used previously.</li>
<li>You’ll also have to run 3 separate regressions for each leaf for a total of nine regressions.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>reg_int <span class="ot">&lt;-</span> <span class="fu">glm</span>(logmove<span class="sc">~</span>log_price<span class="sc">*</span>feat <span class="sc">+</span> logprice_tropicana<span class="sc">*</span>feat <span class="sc">+</span> logprice_minutemaid<span class="sc">*</span>feat, <span class="at">data=</span>oj_dominicks)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># treefit3 &lt;- rpart(as.formula(logmove~log_price*feat + logprice_tropicana*feat + logprice_minutemaid*feat),data=oj_dominicks,method="anova",cp=0.007)</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># draw.tree(treefit3)</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># rpart.plot(treefit3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this example, we are investigating the own and cross price elasticities for Dominick’s brand (D) within leaf L.</p>
<ol type="i">
<li><p>Save the coefficients for each leaf in a 3x3 matrix. The diagonals will be own price elasticities and the off diagonals will be cross price elasticities.</p></li>
<li><p>There will be a unique 3x3 matrix for each leaf.</p></li>
<li><p>The 3x3 matrices WON’T be upper triangular because we’re estimating three unique regressions for each leaf.<br>
</p></li>
<li><p>Comment on any differences between own and cross price elasticities by leaf.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># split the dataset according to the leave</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>oj_leaves <span class="ot">&lt;-</span> <span class="fu">split</span>(dataToPass, dataToPass<span class="sc">$</span>leaf)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>oj_leaf_2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(oj_leaves[[<span class="dv">1</span>]])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>oj_leaf_4 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(oj_leaves[[<span class="dv">2</span>]])</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>oj_leaf_5 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(oj_leaves[[<span class="dv">3</span>]])</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>oj_leaf_2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(oj_leaf_2, oj_with_Q, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"age60"</span>, <span class="st">"educ"</span>, <span class="st">"ethnic"</span>, <span class="st">"income"</span>, <span class="st">"hhlarge"</span>, <span class="st">"workwom"</span>, <span class="st">"hval150"</span>, <span class="st">"sstrdist"</span>, <span class="st">"sstrvol"</span>, <span class="st">"cpdist5"</span>, <span class="st">"cpwvol5"</span>, <span class="st">"weighted_mean"</span>))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>reg_int_2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(logmove <span class="sc">~</span> <span class="fu">log</span>(price) <span class="sc">*</span> brand <span class="sc">*</span> feat, <span class="at">data =</span> oj_leaf_2)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>oj_leaf_4 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(oj_leaf_4, oj_with_Q, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"age60"</span>, <span class="st">"educ"</span>, <span class="st">"ethnic"</span>, <span class="st">"income"</span>, <span class="st">"hhlarge"</span>, <span class="st">"workwom"</span>, <span class="st">"hval150"</span>, <span class="st">"sstrdist"</span>, <span class="st">"sstrvol"</span>, <span class="st">"cpdist5"</span>, <span class="st">"cpwvol5"</span>, <span class="st">"weighted_mean"</span>))</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>reg_int_4 <span class="ot">&lt;-</span> <span class="fu">glm</span>(logmove <span class="sc">~</span> <span class="fu">log</span>(price) <span class="sc">*</span> brand <span class="sc">*</span> feat, <span class="at">data =</span> oj_leaf_4)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>oj_leaf_5 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(oj_leaf_5, oj_with_Q, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"age60"</span>, <span class="st">"educ"</span>, <span class="st">"ethnic"</span>, <span class="st">"income"</span>, <span class="st">"hhlarge"</span>, <span class="st">"workwom"</span>, <span class="st">"hval150"</span>, <span class="st">"sstrdist"</span>, <span class="st">"sstrvol"</span>, <span class="st">"cpdist5"</span>, <span class="st">"cpwvol5"</span>, <span class="st">"weighted_mean"</span>))</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>reg_int_5 <span class="ot">&lt;-</span> <span class="fu">glm</span>(logmove <span class="sc">~</span> <span class="fu">log</span>(price) <span class="sc">*</span> brand <span class="sc">*</span> feat, <span class="at">data =</span> oj_leaf_5)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>epsilon_2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(reg_int_2)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>epsilon_4 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(reg_int_4)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>epsilon_5 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">summary</span>(reg_int_5)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>epsilon_byleaf <span class="ot">&lt;-</span> <span class="fu">rbind</span>(epsilon_2, epsilon_4, epsilon_5)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>epsilon_byleaf <span class="sc">%&gt;%</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<tbody>
<tr class="odd">
<td style="text-align: left;">epsilon_2</td>
<td style="text-align: right;">-2.834347</td>
<td style="text-align: right;">0.0709283</td>
<td style="text-align: right;">0.8088127</td>
</tr>
<tr class="even">
<td style="text-align: left;">epsilon_4</td>
<td style="text-align: right;">-2.611296</td>
<td style="text-align: right;">0.1393551</td>
<td style="text-align: right;">0.9041316</td>
</tr>
<tr class="odd">
<td style="text-align: left;">epsilon_5</td>
<td style="text-align: right;">-3.041151</td>
<td style="text-align: right;">0.4594412</td>
<td style="text-align: right;">1.5576656</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>oj_with_leaves <span class="ot">&lt;-</span> <span class="fu">left_join</span>(dataToPass, oj, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"age60"</span>, <span class="st">"educ"</span>, <span class="st">"ethnic"</span>, <span class="st">"income"</span>, <span class="st">"hhlarge"</span>, <span class="st">"workwom"</span>, <span class="st">"hval150"</span>, <span class="st">"sstrdist"</span>, <span class="st">"sstrvol"</span>, <span class="st">"cpdist5"</span>, <span class="st">"cpwvol5"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="7" type="1">
<li>Now let’s use the elasticities to think about pricing differentials.</li>
</ol>
<p>a.In the leaf with the highest own-price elasticities, what should the markups be relative to the other leafs?</p>
<p>b.How do cross-price elasticities vary with the highest versus lowest own price elasticity leafs?</p>
<ol type="i">
<li><p>What does this imply about differences in markups within high versus low elasticity stores across brands? <span class="math display">\[\text{markup} = \frac{\text{margin}}{\text{cost}}\]</span></p></li>
<li><p>Can you say anything about what this means for the timing of sales? Should they occur at the same or different times across stores?</p></li>
</ol>
<ul>
<li>It depends on the price sensitivity of target consumers. If they occur at the same time, the consumers might not have the incentive to purchase product from particular brand.</li>
</ul>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>